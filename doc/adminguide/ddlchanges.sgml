<!--  -->
<sect1 id="ddlchanges">
<title>Database Schema Changes (DDL)</title>

<indexterm>
 <primary>DDL changes</primary>
 <secondary>database schema changes</secondary>
</indexterm>

<para>When changes are made to the database schema,
<emphasis>e.g.</emphasis> - adding fields to a table, it is necessary
for this to be handled rather carefully, otherwise different nodes may
get rather deranged because they disagree on how particular tables are
built.</para>

<para>If you pass the changes through &slony1; via <xref
linkend="stmtddlscript"> (slonik),
this allows you to be certain that the changes take effect at the same
point in the transaction streams on all of the nodes. This may not be 
important to you depending on the nature of your change.  You should still
make sure that no transactions are changing the tables that your script
uses while the EXECUTE SCRIPT command is running on the master.</para>

<para>It is essential to use <command>EXECUTE SCRIPT</command> if you
alter the names of tables or the namespace they reside in.  If you do not
then &slony1; will be unaware of the new table name.
</para>

<para>It's worth making a couple of comments on <quote>special
things</quote> about <xref linkend="stmtddlscript">:</para>

<itemizedlist>

<listitem><para>The script <emphasis>must not</emphasis> contain
transaction <command>BEGIN</command> or <command>END</command>
statements, as the script is already executed inside a transaction
though nested transactions are allowed as long are processed
within the scope of a single transaction whose <command>BEGIN</command> 
and <command>END</command> you do not control.</para></listitem>

<listitem><para>If there is <emphasis>anything</emphasis> broken about
the script, or about how it executes on a particular node, this will
cause the <xref linkend="slon"> daemon for that node to panic and
crash.  You may see various expected messages (positive and negative)
in <xref linkend="ddllogs">.  If you restart the slon, it will,
most likely, try to
<emphasis>repeat</emphasis> the DDL script, which will, almost
certainly, fail the second time in the same way it did the first time.
</para>

<para> The implication of this is that it is
<emphasis>vital</emphasis> that modifications not be made in a
haphazard way on one node or another.  The schemas must always stay in
sync.</para> </listitem>  
</itemizedlist>

<para> If slon; fails due to a failed DDL change then
you should manually (via psql) make the required changes so that the
DDL change succeeds the next time slon attempts it.</para>

</sect1>
<!-- Keep this comment at the end of the file
Local variables:
mode:sgml
sgml-omittag:nil
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
sgml-parent-document:"slony.sgml"
sgml-exposed-tags:nil
sgml-local-catalogs:("/usr/lib/sgml/catalog")
sgml-local-ecat-files:nil
End:
-->
